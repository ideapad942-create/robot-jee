<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Microstock Metadata Generator - Groq API</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .tab-btn.active { border-bottom: 2px solid #2563eb; color: #2563eb; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4 md:p-8">

    <div class="max-w-4xl mx-auto bg-white rounded-xl shadow-lg overflow-hidden">
        <div class="flex border-b bg-gray-100">
            <button onclick="openTab('api-tab')" id="btn-api-tab" class="tab-btn active px-6 py-3 font-medium">1. Konfigurasi API</button>
            <button onclick="openTab('input-tab')" id="btn-input-tab" class="tab-btn px-6 py-3 font-medium">2. Input Perintah</button>
            <button onclick="openTab('output-tab')" id="btn-output-tab" class="tab-btn px-6 py-3 font-medium">3. Hasil & Export</button>
        </div>

        <div class="p-6">
            <div id="api-tab" class="tab-content active">
                <h2 class="text-xl font-bold mb-4">Pengaturan API Groq</h2>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Masukkan API Key Groq:</label>
                    <input type="password" id="api-key" placeholder="gsk_xxxx..." class="w-full p-2 border rounded-md focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="bg-blue-50 p-4 rounded-md border border-blue-200">
                    <p class="text-sm text-blue-800">
                        <strong>Belum punya API Key?</strong><br>
                        Anda bisa membuatnya secara gratis di: 
                        <a href="https://console.groq.com/keys" target="_blank" class="underline font-bold text-blue-600">Groq Console Keys</a>
                    </p>
                </div>
                <button onclick="openTab('input-tab')" class="mt-6 bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700">Lanjut ke Input</button>
            </div>

            <div id="input-tab" class="tab-content">
                <h2 class="text-xl font-bold mb-4">Generate Metadata</h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Perintah Utama (Contoh: "50 title lens flare"):</label>
                        <textarea id="main-prompt" rows="3" class="w-full p-2 border rounded-md mt-1" placeholder="Masukkan instruksi jumlah dan jenis asset..."></textarea>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="flex items-center p-3 border rounded bg-gray-50">
                            <input type="checkbox" id="gen-desc" class="w-4 h-4 text-blue-600">
                            <label for="gen-desc" class="ml-2 text-sm">Generate Deskripsi (150-200 kata)</label>
                        </div>
                        <div class="flex items-center p-3 border rounded bg-gray-50">
                            <input type="checkbox" id="gen-key" checked class="w-4 h-4 text-blue-600">
                            <label for="gen-key" class="ml-2 text-sm">Generate Keywords (41 kata per item)</label>
                        </div>
                    </div>

                    <button id="process-btn" onclick="generateMetadata()" class="w-full bg-green-600 text-white py-3 rounded-md font-bold hover:bg-green-700 transition">
                        Mulai Generate Sekarang
                    </button>
                </div>
            </div>

            <div id="output-tab" class="tab-content">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">Hasil Metadata</h2>
                    <button onclick="downloadCSV()" id="download-btn" class="hidden bg-black text-white px-4 py-2 rounded-md text-sm hover:bg-gray-800">
                        Download CSV
                    </button>
                </div>
                
                <div id="loading-state" class="hidden text-center py-10">
                    <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-600 mx-auto"></div>
                    <p class="mt-2 text-gray-600">Sedang memproses ke API Groq...</p>
                </div>

                <div id="result-area" class="space-y-4 max-h-[500px] overflow-y-auto border p-4 rounded bg-gray-50">
                    <p class="text-gray-400 italic">Belum ada data yang di-generate.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let generatedData = [];

        function openTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            document.getElementById('btn-' + tabId).classList.add('active');
        }

        async function generateMetadata() {
            const apiKey = document.getElementById('api-key').value;
            const mainPrompt = document.getElementById('main-prompt').value;
            const needDesc = document.getElementById('gen-desc').checked;
            const needKey = document.getElementById('gen-key').checked;

            if (!apiKey) return alert("Harap masukkan API Key!");
            if (!mainPrompt) return alert("Harap masukkan perintah!");

            // Prepare UI
            openTab('output-tab');
            document.getElementById('loading-state').classList.remove('hidden');
            document.getElementById('result-area').innerHTML = '';
            document.getElementById('download-btn').classList.add('hidden');

            // Construct System Prompt
            let instructions = `Anda adalah pakar metadata Microstock US. Fokus pada fungsi asset, BUKAN warna, objek manusia, atau model. 
            Title harus < 100 karakter (bukan kata, sesuai standar microstock).
            ${needDesc ? 'Berikan deskripsi 150-200 kata fokus pada kegunaan teknis.' : ''}
            ${needKey ? 'Berikan tepat 41 kata kunci (keywords) dipisahkan koma. Contoh: "light, leak, ..." ' : ''}
            Output harus dalam format JSON ARRAY dengan key: "title" ${needDesc ? ', "description"' : ''} ${needKey ? ', "keywords"' : ''}.
            Sesuaikan jumlah item dengan permintaan user: "${mainPrompt}".`;

            try {
                const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: "llama-3.3-70b-versatile",
                        messages: [
                            { role: "system", content: instructions },
                            { role: "user", content: mainPrompt }
                        ],
                        response_format: { type: "json_object" }
                    })
                });

                const data = await response.json();
                const content = JSON.parse(data.choices[0].message.content);
                
                // Asumsikan Groq mengembalikan object dengan key 'data' atau 'items'
                const items = content.items || content.data || Object.values(content)[0];
                generatedData = items;

                displayResults(items);
                document.getElementById('download-btn').classList.remove('hidden');
            } catch (error) {
                alert("Terjadi kesalahan: " + error.message);
            } finally {
                document.getElementById('loading-state').classList.add('hidden');
            }
        }

        function displayResults(items) {
            const container = document.getElementById('result-area');
            container.innerHTML = items.map((item, index) => `
                <div class="p-3 border-b border-gray-200">
                    <p class="font-bold text-blue-600">Item ${index + 1}</p>
                    <p><strong>Title:</strong> ${item.title}</p>
                    ${item.description ? `<p><strong>Desc:</strong> ${item.description}</p>` : ''}
                    ${item.keywords ? `<p><strong>Keywords:</strong> ${item.keywords}</p>` : ''}
                </div>
            `).join('');
        }

        function downloadCSV() {
            if (generatedData.length === 0) return;

            let csvContent = "data:text/csv;charset=utf-8,";
            
            // Header
            const keys = Object.keys(generatedData[0]);
            csvContent += keys.join(",") + "\r\n";

            // Rows
            generatedData.forEach(item => {
                const row = keys.map(key => {
                    let val = item[key] ? item[key].toString().replace(/"/g, '""') : '';
                    return `"${val}"`;
                });
                csvContent += row.join(",") + "\r\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "microstock_metadata.csv");
            document.body.appendChild(link);
            link.click();
        }
    </script>
</body>
</html>
